+++
title = "Notes for Ben"
date = 2019-07-10
draft = true
+++

## Installs Maybe?
- Codebase
  - `git clone https://github.com/FreeMasen/RESS`
- Rust
  - `curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh`
- [VSCode Live](https://docs.microsoft.com/en-us/visualstudio/liveshare/use/vscode)
- [VSCode Rust](https://marketplace.visualstudio.com/items?itemName=rust-lang.rust)

## App Overview
### Goal
This is the foundational layer of a Javascript parser, the main goal is to look at any JS text and separate it into logical parts e.g keywords, punctuation, number literals etc.   

### The Layout
There is a layed architecture to this application, the layers are as follows

- `Scanner`:  `/src/lib.rs`
  - The API exposed to the user. This is an iterator that provides a series of JS Token + Metadata structures
  - This structure has 2 major responsibilities
    - Calculating the line/column start and end for each token
    - Determining if a `/` is division or a regex literal (surprisingly complicated)
- `Tokenizer`: `/src/tokenizer/mod.rs`
  - This is used by the scanner to get a rawer version of the token + metadata
  - It moves character by character through the text to determine what kind of token is next
  - It has a similar structure to an iterator but offers two paths
    - The primary path will determine the next non-regex token
    - The secondary path is for the remainder of the regex (after the `/`)
- `JSBuffer`: `/src/tokenizer/buffer.rs`
  - This will evaluate the contents of the js string and parse out the next single unicode character
  - There are a number of convenience methods here for testing what might be coming next

In addition to this tiered structure there are a few other characters in play. First are the 3 different token sets.
- `Token`: `/src/tokens.rs`
  - This is what the end user will be using
- `MetaToken`: `/src/tokenizer/tokens.rs`
  - This is a subset of tokens used to determine if the `/` is a regex or not
- `RawToken`: `/src/tokenizer/tokens.rs`
  - This is what is produced by the Tokenizer, it contains slightly different information than what the user would want but is invaluable to the Scanner

Next is the `LookBehind` (`/src/look_behind.rs`), essentially is a 3 item queue. Every time a new element is added to the queue it moves any previous items back. Once there are more than 3 items in the queue the oldest item falls out of the queue. The scanner keeps 2 of these on hand, one for the current last 3 tokens and a second for the three tokens before the last open parenthesis. This is used in the regex logic.  

The actual implementation of this is actually more like a ring buffer, that means we are doing far less memory moving and de/allocation. It keeps an internal pointer and overwrites the oldest element, since it is a constant size it is easy to determine what is index 0, 1 or 2 based on this pointer. It exposes 3 methods instead of any sort of indexing API, `last`, `two` and `three`.

There is also an `Error` defined in `/src/error.rs` that represents the errors exposed by the `Scanner`. There is also an internal `RawError` which represents the `Tokenizer`'s errors found in `/src/tokenizer/mod.rs`

Lastly there are some unicode helper functions defined in `/src/tokenizer/unicode.rs` these are generated by a small command line utility based on some unicode tables. It isn't very pretty but shouldn't need much attention.

## The Issue
Currently, JS does not allow for number literals to contain separators however there is a [proposal](https://github.com/tc39/proposal-numeric-separator) to add this to the language. the `_` character is now going to be a legal character in every position except the very first or last position in a number.

```js
let x = 1_000_000; //1 million!
let y = 1_; // ERROR!
```

To tackle this, we are going to be making our changes in the `Tokenizer`. In the functions that parse/test for numbers, we now need to say that `_` is a valid number (so long as its not the last one).

- `Tokenizer`
  - `number`
  - `dec_number`
  - `oct_number`
  - `hex_number` 
  - `bin_number`